name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
    build_push:
      name: Build & push Docker image
      runs-on: ubuntu-latest
      if: github.event.base_ref == 'refs/heads/master'

      steps:
        - name: Check out code
          uses: actions/checkout@v2.3.0
          with:
            fetch-depth: 0

        - name: Get docker info
          id: docker_info
          run: make docker-info

        - name: Authenticate with Docker registry
          run: echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin ${{ steps.docker_info.outputs.docker_registry }}

        - name: Build & push
          run: make docker-push
