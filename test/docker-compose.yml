version: '3'

services:
    # HTTP container
    autoenv-default:
        environment:
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            PORT: 80
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80

    autoenv-port-test:
        environment:
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            PORT: 8080
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 8080

    autoenv-custom:
        environment:
            AUTOENV_HTTP_PATH: /__myvars
            AUTOENV_PREFIX: MYVAR_
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            MYVAR_1: my_value_1
            MYVAR_2: my_value_2
            PORT: 80
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80

    # HTML injection test containers
    autoenv-html-default:
        environment:
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            PORT: 80
            AUTOENV_INJECT_HTML: true
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80
        volumes:
            - ./html_templates/index.html:/app/index.html

    autoenv-html-custom:
        environment:
            AUTOENV_PREFIX: MYVAR_
            AUTOENV_GLOBAL_VAR: window.myCustomConfig
            MYVAR_1: my_value_1
            MYVAR_2: my_value_2
            PORT: 80
            AUTOENV_INJECT_HTML: true
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80
        volumes:
            - ./html_templates/custom.html:/app/index.html

    autoenv-html-disabled:
        environment:
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            PORT: 80
            AUTOENV_INJECT_HTML: false
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80
        volumes:
            - ./html_templates/disabled.html:/app/index.html

    # Test that all .html files are processed, not just index.html
    autoenv-html-multi:
        environment:
            APP_VAR_1: value_1
            APP_VAR_2: value_2
            PORT: 80
            AUTOENV_INJECT_HTML: true
        image: ${AUTOENV_IMAGE}
        networks:
            - default
        expose:
            - 80
        volumes:
            - ./html_templates/multi-index.html:/app/index.html
            - ./html_templates/about.html:/app/about.html

    test_runner:
        image: alpine
        depends_on:
            - autoenv-default
            - autoenv-port-test
            - autoenv-custom
            - autoenv-html-default
            - autoenv-html-custom
            - autoenv-html-disabled
            - autoenv-html-multi
        networks:
            - default
        volumes:
            - .:/work
        working_dir: /work
        command: /work/test.sh
